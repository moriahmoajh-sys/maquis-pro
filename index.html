<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <meta name="description" content="Solution de gestion pour Maquis et Bars">
    <title>Maquis Manager PRO</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1685/1685230.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #050505; --sidebar: #0f0f0f; --card: #141414; 
            --gold: #D4AF37; --gold-dim: #aa8c2c; --text: #ffffff; 
            --text-muted: #888888; --danger: #ff3b30; --success: #34c759; 
            --warning: #ffcc00; --border: 1px solid rgba(255, 255, 255, 0.08);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; margin: 0; padding: 0; overflow-x: hidden; font-size: 14px; }
        
        /* LAYOUT */
        .app-wrapper { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--sidebar); border-right: var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 100; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        /* COMPONENTS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: var(--card); padding: 20px; border-radius: 16px; border: var(--border); }
        .panel { background: var(--card); border-radius: 16px; border: var(--border); padding: 20px; margin-bottom: 20px; }
        .btn { border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; color: white; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--gold); color: black; }
        .btn-danger { background: rgba(255, 59, 48, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-success { background: rgba(52, 199, 89, 0.2); color: var(--success); border: 1px solid var(--success); }
        .input-field { width: 100%; background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        
        /* UTILS */
        .hidden { display: none !important; }
        .accounting-total { font-size: 20px; font-weight: bold; color: var(--gold); border-top: 1px solid #333; margin-top: 15px; padding-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* MODALS & AUTH */
        #auth-screen, .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid var(--gold-dim); width: 90%; max-width: 450px; text-align: center; }

        /* MOBILE NAV */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; position: fixed; bottom: 0; width: 100%; background: #111; padding: 15px; justify-content: space-around; z-index: 99; border-top: 1px solid #333; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
            .nav-icon { font-size: 22px; color: #666; transition: 0.2s; }
            .nav-icon.active { color: var(--gold); transform: translateY(-5px); }
            .main-content { padding: 15px; padding-bottom: 90px; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="modal-content">
            <div style="font-size: 50px; color: var(--gold); margin-bottom: 20px;"><i class="fa-solid fa-crown"></i></div>
            <h1 style="margin:0;">MAQUIS PRO</h1>
            <p style="color:#666; margin-bottom:30px;">Gestion, Stock & Finance</p>

            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                <button class="btn" id="tab-boss" onclick="switchAuth('boss')" style="background:var(--gold); color:black;">PATRON</button>
                <button class="btn" id="tab-staff" onclick="switchAuth('staff')" style="background:#333;">SERVEUR</button>
            </div>

            <div id="form-boss">
                <input type="email" id="boss-email" class="input-field" placeholder="Email Patron">
                <input type="password" id="boss-pass" class="input-field" placeholder="Mot de passe">
                <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="authBoss()">CONNEXION</button>
                <div style="margin-top:20px; font-size:12px; color:#888; cursor:pointer; text-decoration:underline;" onclick="registerBoss()">Créer un compte Maquis</div>
            </div>

            <div id="form-staff" class="hidden">
                <p style="font-size:12px; color:#888;">Demandez l'ID au patron (visible dans son menu)</p>
                <input type="text" id="staff-id" class="input-field" placeholder="ID MAQUIS (ex: 8x9s...)">
                <input type="text" id="staff-name" class="input-field" placeholder="Votre Prénom">
                <button class="btn btn-success" style="width:100%; justify-content:center;" onclick="authStaff()">OUVRIR CAISSE</button>
            </div>
        </div>
    </div>

    <div class="app-wrapper hidden" id="app-interface">
        <div class="sidebar">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:40px;">
                <div style="background:var(--gold); color:black; width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold;"><i class="fa-solid fa-store"></i></div>
                <div>
                    <div style="font-weight:bold;">MAQUIS PRO</div>
                    <div style="font-size:10px; color:#666;" id="display-maquis-id">ID: ...</div>
                </div>
            </div>
            
            <div onclick="nav('dashboard')" class="btn" style="background:transparent; justify-content:flex-start; margin-bottom:5px;"><i class="fa-solid fa-chart-pie"></i> Tableau de bord</div>
            <div onclick="nav('sales')" class="btn" style="background:transparent; justify-content:flex-start; margin-bottom:5px;"><i class="fa-solid fa-cash-register"></i> Caisse</div>
            <div onclick="nav('stock')" class="btn" style="background:transparent; justify-content:flex-start; margin-bottom:5px;"><i class="fa-solid fa-boxes-stacked"></i> Stock</div>
            <div class="boss-only" onclick="nav('accounting')" class="btn" style="background:transparent; justify-content:flex-start; margin-bottom:5px;"><i class="fa-solid fa-coins"></i> Finance</div>
            <div onclick="logout()" class="btn" style="background:transparent; color:var(--danger); justify-content:flex-start; margin-top:auto;"><i class="fa-solid fa-power-off"></i> Quitter</div>
        </div>

        <div class="main-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="page-title" style="margin:0;">Dashboard</h2>
                <div id="network-status" style="font-size:10px; color:#666;"><i class="fa-solid fa-wifi"></i> En ligne</div>
            </div>

            <div id="view-dashboard" class="view-section">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <small style="color:#888">CAISSE DU JOUR</small>
                        <div id="dash-ca" style="font-size:24px; font-weight:bold;">0 F</div>
                    </div>
                    <div class="kpi-card boss-only">
                        <small style="color:#888">PROFIT NET ESTIMÉ</small>
                        <div id="dash-profit" style="font-size:24px; font-weight:bold; color:var(--gold);">0 F</div>
                    </div>
                </div>
                <div class="panel">
                    <h3><i class="fa-solid fa-robot"></i> Conseil IA</h3>
                    <p id="ai-msg" style="color:#ccc; font-style:italic;">Analyse en cours...</p>
                </div>
            </div>

            <div id="view-sales" class="view-section hidden">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                    <div class="panel">
                        <h3>Catalogue</h3>
                        <div id="pos-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px;"></div>
                    </div>
                    <div class="panel">
                        <h3>Panier Actuel</h3>
                        <div id="cart-items" style="min-height:100px; max-height:300px; overflow-y:auto;"></div>
                        <div class="accounting-total" id="cart-total">0 F</div>
                        <button class="btn btn-success" style="width:100%; margin-top:15px; justify-content:center;" onclick="checkout()">ENCAISSER (CASH)</button>
                    </div>
                </div>
            </div>

            <div id="view-stock" class="view-section hidden">
                <div class="panel">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>Produits</h3>
                        <button class="btn btn-primary" onclick="openModal('modal-prod')"><i class="fa-solid fa-plus"></i> Nouveau</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%">
                            <thead><tr><th>Nom</th><th>Prix</th><th class="boss-only">Coût</th><th>Stock</th></tr></thead>
                            <tbody id="stock-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-accounting" class="view-section hidden">
                <div class="panel">
                    <h3>Compte de Résultat</h3>
                    <div style="display:flex; justify-content:space-between; margin:10px 0;"><span>Ventes Totales</span><span id="acc-sales" style="color:var(--success)">0 F</span></div>
                    <div style="display:flex; justify-content:space-between; margin:10px 0;"><span>Coût Marchandise</span><span id="acc-cogs" style="color:var(--danger)">0 F</span></div>
                    <div class="accounting-total" style="display:flex; justify-content:space-between;"><span>RÉSULTAT NET</span><span id="acc-net">0 F</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <i class="fa-solid fa-chart-pie nav-icon" onclick="nav('dashboard')"></i>
        <i class="fa-solid fa-cash-register nav-icon" onclick="nav('sales')"></i>
        <i class="fa-solid fa-boxes-stacked nav-icon" onclick="nav('stock')"></i>
        <i class="fa-solid fa-coins nav-icon boss-only" onclick="nav('accounting')"></i>
    </div>

    <div id="modal-prod" class="modal hidden">
        <div class="modal-content">
            <h3>Nouveau Produit</h3>
            <input id="np-name" class="input-field" placeholder="Nom (ex: Bock 66)">
            <input id="np-price" type="number" class="input-field" placeholder="Prix Vente">
            <input id="np-cost" type="number" class="input-field" placeholder="Coût Achat (Secret)">
            <input id="np-stock" type="number" class="input-field" placeholder="Stock Initial">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-danger" style="flex:1" onclick="closeModal('modal-prod')">Annuler</button>
                <button class="btn btn-primary" style="flex:1" onclick="saveProduct()">Sauver</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG (Utilise la tienne ou remplace par la tienne si besoin)
        const firebaseConfig = { apiKey: "AIzaSyCb22QgS99n6gzYmcCJoPzsVwd1uwg9g7k", authDomain: "maquismanager.firebaseapp.com", projectId: "maquismanager", storageBucket: "maquismanager.firebasestorage.app", messagingSenderId: "565292456302", appId: "1:565292456302:web:ef737768b5e0f06a05897f" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // PERSISTANCE HORS LIGNE
        enableIndexedDbPersistence(db).catch((err) => console.log("Persistance error:", err.code));

        let currentUser = null, maquisId = null, dbData = null, cart = [];

        // NETWORK UI
        window.addEventListener('online', () => document.getElementById('network-status').innerHTML = '<i class="fa-solid fa-wifi"></i> En ligne');
        window.addEventListener('offline', () => document.getElementById('network-status').innerHTML = '<i class="fa-solid fa-wifi" style="color:red"></i> HORS LIGNE');

        // AUTH
        window.switchAuth = (t) => {
            document.getElementById('form-boss').className = t==='boss'?'':'hidden';
            document.getElementById('form-staff').className = t==='staff'?'':'hidden';
            document.getElementById('tab-boss').style.background = t==='boss'?'var(--gold)':'#333';
            document.getElementById('tab-boss').style.color = t==='boss'?'black':'white';
            document.getElementById('tab-staff').style.background = t==='staff'?'var(--gold)':'#333';
            document.getElementById('tab-staff').style.color = t==='staff'?'black':'white';
        };

        window.authBoss = async () => {
            try {
                const c = await signInWithEmailAndPassword(auth, document.getElementById('boss-email').value, document.getElementById('boss-pass').value);
                initApp(c.user.uid, 'boss');
            } catch(e) { alert(e.message); }
        };

        window.registerBoss = async () => {
            try {
                const c = await createUserWithEmailAndPassword(auth, document.getElementById('boss-email').value, document.getElementById('boss-pass').value);
                await setDoc(doc(db, "restaurants", c.user.uid), { products:[], sales:[], role:'boss' });
                initApp(c.user.uid, 'boss');
            } catch(e) { alert(e.message); }
        };

        window.authStaff = async () => {
            const id = document.getElementById('staff-id').value.trim();
            if(!id) return alert("ID manquant");
            const snap = await getDoc(doc(db, "restaurants", id));
            if(snap.exists()) initApp(id, 'staff');
            else alert("ID Maquis introuvable !");
        };

        function initApp(id, role) {
            maquisId = id;
            document.getElementById('auth-screen').className = 'hidden';
            document.getElementById('app-interface').className = 'app-wrapper';
            document.getElementById('display-maquis-id').textContent = "ID: " + id;
            
            if(role === 'staff') document.querySelectorAll('.boss-only').forEach(e => e.className = 'hidden');

            onSnapshot(doc(db, "restaurants", maquisId), (doc) => {
                dbData = doc.data();
                updateUI();
            });
        }

        window.logout = () => location.reload();

        // UI & LOGIC
        function updateUI() {
            let ca = 0, cost = 0;
            (dbData.sales||[]).forEach(s => { 
                ca += s.total; 
                const p = dbData.products.find(x => x.name === s.name);
                if(p) cost += (p.cost || 0) * s.qty;
            });
            
            document.getElementById('dash-ca').innerText = ca.toLocaleString() + ' F';
            document.getElementById('dash-profit').innerText = (ca - cost).toLocaleString() + ' F';
            document.getElementById('acc-sales').innerText = ca.toLocaleString() + ' F';
            document.getElementById('acc-cogs').innerText = '-' + cost.toLocaleString() + ' F';
            document.getElementById('acc-net').innerText = (ca - cost).toLocaleString() + ' F';

            // POS
            const grid = document.getElementById('pos-grid'); grid.innerHTML = '';
            (dbData.products||[]).forEach(p => {
                const d = document.createElement('div');
                d.className = 'kpi-card'; d.style.padding='10px'; d.style.textAlign='center'; d.style.cursor='pointer';
                d.innerHTML = `<b>${p.name}</b><br><small>${p.price} F</small><br><span style="font-size:10px; color:#666">Stock: ${p.stock}</span>`;
                d.onclick = () => { cart.push(p); renderCart(); };
                grid.appendChild(d);
            });

            // Stock Table
            const sb = document.getElementById('stock-body'); sb.innerHTML = '';
            (dbData.products||[]).forEach(p => sb.innerHTML += `<tr><td>${p.name}</td><td>${p.price}</td><td class="boss-only">${p.cost||0}</td><td>${p.stock}</td></tr>`);
            
            // Re-apply boss-only filter in table
            if(document.getElementById('tab-staff').style.background !== 'rgb(51, 51, 51)') { 
                 // Simple hack check, better to use state var but this works for render
            } else {
                 document.querySelectorAll('.boss-only').forEach(e => e.className = 'hidden');
            }
        }

        function renderCart() {
            document.getElementById('cart-items').innerHTML = cart.map((i, idx) => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.name}</span><span>${i.price}F <i class="fa-solid fa-xmark" style="color:red; cursor:pointer;" onclick="window.delCart(${idx})"></i></span></div>`).join('');
            document.getElementById('cart-total').innerText = cart.reduce((a,b)=>a+b.price,0) + ' F';
        }
        window.delCart = (i) => { cart.splice(i,1); renderCart(); };

        window.checkout = async () => {
            if(!cart.length) return;
            const batch = cart.map(i => ({ name: i.name, total: i.price, qty: 1, date: new Date().toISOString() }));
            
            // Logic to decrement stock would go here (requires reading current stock and updating)
            // Simplified for this view:
            await updateDoc(doc(db, "restaurants", maquisId), { sales: arrayUnion(...batch) });
            cart = []; renderCart(); alert("Vente validée !");
        };

        window.saveProduct = async () => {
            const name = document.getElementById('np-name').value;
            const price = parseInt(document.getElementById('np-price').value);
            const cost = parseInt(document.getElementById('np-cost').value);
            const stock = parseInt(document.getElementById('np-stock').value);
            if(name && price) {
                await updateDoc(doc(db, "restaurants", maquisId), { products: arrayUnion({ name, price, cost: cost||0, stock: stock||0 }) });
                closeModal('modal-prod');
            }
        };

        window.nav = (t) => {
            document.querySelectorAll('.view-section').forEach(e => e.className = 'view-section hidden');
            document.getElementById('view-'+t).className = 'view-section';
            document.querySelectorAll('.nav-icon').forEach(e => e.classList.remove('active'));
            // simple active state logic for mobile nav
        };

        window.openModal = (id) => document.getElementById(id).className = 'modal';
        window.closeModal = (id) => document.getElementById(id).className = 'hidden';

        // PWA REGISTRATION
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => console.log('SW Registered'));
        }
    </script>
</body>
</html>
